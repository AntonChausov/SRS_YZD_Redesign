# Задание к занятию «Программная работа со Ссылочными типами. Обновление конфигурации»

*Примерное время выполнения: 20–60 минут*

## Цель задания

1. На практике разобрать работу с ссылочными типами через программный код.
2. Научиться правильно прописывать алгоритм обновления конфигурации.
3. Подготовить конфигурацию к последующей работе.

## Чеклист готовности к домашнему заданию

- [ ] Установить учебную платформу версии 8.3.22 или больше.
- [ ] Подготовить разработанную ранее конфигурацию "УправлениеИТФирмой"
- [ ] Просмотреть материал занятия «Табличные части».

## Инструкция к заданию

1. Решите описанные задачи в конфигураторе.
2. Протестируйте решение в пользовательском режиме, обязательно введите данные в базу, убедитесь, что все работает.
3. Отправьте на проверку в личном кабинете Нетологии один общий файл базы данных (.dt), содержащей решение всех задач.

## Задача 1. Версия конфигурации

### Описание задачи

Необходимо подготовить конфигурацию к возможным обновлениям написать "программную обвязку" для этого. То есть, реализовать алгоритмы, которые мы потом будем использовать при решении задач.

Добавить константу **ВерсияКонфигурации**, которая будет хранить версию конфигурации из свойств метаданных, с которой программа запускалась в последний раз. Хранение версии в данных позволит обнаружить запуск программы с изменённой версией и запустить код, заполняющий недостающие данные при обновлении версии.

### Процесс выполнения

1. Создайте константу **ВерсияКонфигурации** типа **Строка**, которая будет хранить текущую версию конфигурации. 
2. Добавьте константу в подсистему Справочники (или создайте для нее отдельную подсистему "Служебное", в этой подсистеме снимите флаг "Включать в командный интерфейс")
3. Скройте константу из командного интерфейса, сняв в свойствах флажок «Использовать стандартные команды».
4. Создайте общий модуль **ОбновлениеИнформационнойБазыСервер** с экспортной процедурой **ПриНачалеРаботыСистемы**, которая:
* проверит, совпадает ли версия конфигурации (_Метаданные.Версия_) со значением константы (_Константы.ВерсияКонфигурации.Получить()_);
* при совпадении ничего не сделает;
* при выявлении разницы вызовет ПриИзмененииВерсии(СтараяВерсия, НоваяВерсия);
* ПриИзмененииВерсии, в свою очередь, пока будет только устанавливать значение константы равным новой версии из метаданных
<details>
  <summary>Код</summary>
  
  ```bsl
	Процедура ПриНачалеРаботыСистемы() Экспорт

		НоваяВерсия = Метаданные.Версия;
		СтараяВерсия = Константы.ВерсияКонфигурации.Получить();
	
		Если НоваяВерсия = СтараяВерсия Тогда
			Возврат;
		КонецЕсли;
	
		ПриИзмененииВерсии(СтараяВерсия, НоваяВерсия);
	
	КонецПроцедуры

	Процедура ПриИзмененииВерсии(СтараяВерсия, НоваяВерсия)
	
		Константы.ВерсияКонфигурации.Установить(НоваяВерсия);
	
	КонецПроцедуры
  ```
  
</details>
5. Создайте общий модуль **ОбновлениеИнформационнойБазыВызовСервера** (не забудьте установить флаги, чтобы модуль был дступен с клиента) с экспортной процедурой **ПриНачалеРаботыСистемы**, которая вызовет одноименную процедуру в **ОбновлениеИнформационнойБазыСервер**
<details>
  <summary>Код</summary>
  
  ```bsl
	Процедура ПриНачалеРаботыСистемы() Экспорт
	
		ОбновлениеИнформационнойБазыСервер.ПриНачалеРаботыСистемы();
	
	КонецПроцедуры
  ```
	
</details>

6. В модуле приложения пропишите вызов процедуру из **ОбновлениеИнформационнойБазыВызовСервера**
<details>
  <summary>Код</summary>
  
  ```bsl
	Процедура ПриНачалеРаботыСистемы()
	
		ОбновлениеИнформационнойБазыВызовСервер.ПриНачалеРаботыСистемы();
	
	КонецПроцедуры
  ```
	
</details>

7. Таким образом, при обновлении информационной базы старой версии на конфигурацию новой версии будут выполнены обработчики обновления, необходимые новой версии. Сами обработчики обновления писать пока не нужно.
8. Проверьте, что при изменении версии в метаданных и запуске программы значение константы обновляется. Открыть константу можно через режим технического специалиста.

## Задача 2. Виды контактной информации

### Описание задачи

Добавить в справочник «Контрагенты» табличную часть «Контактная информация» для хранения адресов, телефонов и т. п. в разрезе видов контактной информации — так, как это делается в реальных прикладных решениях, вместо хранения каждого вида контактной информации в отдельном реквизите, как мы это делали раньше. 
Для этого потребуется подготовительная работа. Создадим справочник "Виды контактной информации", в котором будет храниться наименование вида информации и ее тип - Адрес, Телефон, EMail, Вебсайт. В справочнике должны быть созданы предопределенные элементы, чтобы заполнить их тип, пропишем обработчик обновления.

Важно! Чтобы проверить успешность выполнения обновления, в пользовательском режиме установите значение константы **ВерсияКонфигурации** на "1.0.0.0" или очистите константу совсем.

### Процесс выполнения

1. Создать перечисление ТипыКонтактнойИнформации со значениями: Адрес, Телефон, EMail, Вебсайт. Укажите подсистему.
2. Создать справочник ВидыКонтактнойИнформации с реквизитом Тип (ПеречислениеСсылка.ТипыКонтактнойИнформации). Укажите подсистему. Справочник будет расширяемым для пользователей, а значение реквизита Тип позволит программе понять, как работать с этим видом Контактной информации.
3. Создать предопределённые виды контактной информации: ЮридическийАдресКонтрагента, ПочтовыйАдресКонтрагента, ФактическийАдресКонтрагента, ТелефонКонтрагента, EMailКонтрагента.
4. В модуле менеджера справочника создать экспортную процедуру **ЗаполнитьПредопределенныеЭлементы**, которая заполнит реквизит Тип у всех предопределённых элементов этого справочника. В Конфигураторе можно задать только код и наименование предопределённых элементов, но не другие реквизиты.
<details>
  <summary>Код</summary>
  
  ```bsl
  Процедура ЗаполнитьПредопределенныеЭлементы() Экспорт
	
	ТипАдрес = Перечисления.ТипыКонтактнойИнформации.Адрес; 
	
	ПредопределенныйОбъект = Справочники.ВидыКонтактнойИнформации.ЮридическийАдресКонтрагента.ПолучитьОбъект();
	ПредопределенныйОбъект.Тип = ТипАдрес;
	ПредопределенныйОбъект.Записать();
	
	// На самом деле, так как мы находимся в модуле менеджера справочника ВидыКонтактнойИнформации,
	// можно не писать "Справочники.ВидыКонтактнойИнформации", мы и так в этом контексте.
	ПредопределенныйОбъект = ПочтовыйАдресКонтрагента.ПолучитьОбъект();
	ПредопределенныйОбъект.Тип = ТипАдрес;
	ПредопределенныйОбъект.Записать();
	
	ПредопределенныйОбъект = ФактическийАдресКонтрагента.ПолучитьОбъект();
	ПредопределенныйОбъект.Тип = ТипАдрес;
	ПредопределенныйОбъект.Записать();
	
	ПредопределенныйОбъект = ТелефонКонтрагента.ПолучитьОбъект();
	ПредопределенныйОбъект.Тип = Перечисления.ТипыКонтактнойИнформации.Телефон;
	ПредопределенныйОбъект.Записать();
	
	ПредопределенныйОбъект = EMailКонтрагента.ПолучитьОбъект();
	ПредопределенныйОбъект.Тип = Перечисления.ТипыКонтактнойИнформации.EMail;
	ПредопределенныйОбъект.Записать();
	
  КонецПроцедуры
  ```
	
</details>
	
5. Установить версию конфигурации в метаданных на следующее значение (например, 1.0.0.1, если До этого Вы не забыли очистить или установить 1.0.0.0).
6. В процедуре **ПриИзмененииВерсии**:
* проверить, не находится ли установленная версия 1.0.0.1 между значениями параметров СтараяВерсия и НоваяВерсия. Если старая версия пуста, значит, она меньше любой текущей;
* если версия 1.0.0.1 находится между старой и новой версией, включая границы, — вызвать процедуру ЗаполнитьПредопределенныеЭлементы().


## Задача 3. Перенос контактной информации справочника Контрагенты в табличную часть.

### Описание задачи

Сделать обработчик переноса контактной информации из отдельных реквизитов в табличную часть — так, как это делается при обновлении в реальных прикладных решениях.

Важно! Чтобы проверить успешность переноса, не забудьте предварительно заполнить контактную информацию некоторых контрагентов в отдельных реквизитах.


### Процесс выполнения

1. Добавьте в форму реквизит СортироватьПоВозрастанию с типом Булево. Данный реквизит будет хранить текущее направление сортировки, на форму его выводить не нужно.
2. При каждом нажатии на кнопку, меняйте значение данного реквизита.
3. В зависимости от значения реквизита, сортируйте таблицу по возрастанию или убыванию.
4. Так же, можно менять заголовок и картинку на кнопке

## Задача 4*. Расчет количества по сумме

_Это дополнительная задача, реализовывать ее не обязательно._
_Задача предназначена для тех студентов, которым первые 2 покажутся слишкм простыми._
_В процессе выполнения не будут даны примеры программного кода._

### Описание задачи

Реализуйте более сложные расчеты в таблице для документа Реализация товаров и услуг. Например, к нам приходит покупатель и просит продать ему максимальное количество товара на определенную сумму. Необходимо рассчитать максимальное количество товара на указанную сумму.

### Процесс выполнения

1. Добавьте обработчик изменения суммы.
2. Если цена не установлена - никакие расчеты выполняться не должны.
3. Рассчитайте максимальное целое количество товара, которое можно продать по указанной цене.
4. Рассчитайте актуальную сумму.

## Пример
[Пример выполнения домашнего задания](examples/HW_4_2_example.md)

## Критерии оценки

Зачёт ставится, если:
1. Программа запускается, не возникает явных ошибок, исключений при выполнении программы (в том числе, если Вы начали делать дополнительную задачу, ее функционал не должен приводить к ошибкам и исключениям)
2. Присутствует справочник ВидыКонтактнойИнформации с пятью предопределенными элементами: ЮридическийАдресКонтрагента, ПочтовыйАдресКонтрагента, ФактическийАдресКонтрагента, ТелефонКонтрагента, EMailКонтрагента и реквизитом Тип (ПеречислениеСсылка.ТипыКонтактнойИнформации);
3. В справочнике Контрагенты присутствует табличная часть КонтактнаяИнформация, данные которой выведены на форму контрагента таблицей, а прежние реквизиты, напротив, имеют префикс Удалить и скрыты с формы;
4. Присутствует код, при начале работы системы сравнивающий версию из метаданных и версию из константы, и:
* при переходе на версию 1.0.0.1 или более новую, а также при первом запуске инициирующий заполнение типов предопределенных элементов справочника ВидыКонтактнойИнформации;
* при переходе на версию 1.0.0.2 или более новую, а также при первом запуске инициирующий перенос контактной информации из реквизитов Удалить<...> в ТЧ КонтактнаяИнформация.
5. Введены тестовые данные.

Задачи 1 и 2 обязательны к выполнению (кроме текста под спойлером "Дополнительно" - эти задачи делать не обязательно. Возможно, Вы вернетесь к ним позднее, после того, как изучите дополнительный материал). Задача 3 и 4 - не обязательны. 

Пожалуйста, присылайте на проверку все задачи сразу, одним файлом выгрузки информационной базы (dt)

Любые вопросы по решению задач задавайте в чате учебной группы.

