# Задание к занятию «Программная работа со Ссылочными типами. Обновление конфигурации»

*Примерное время выполнения: 20–60 минут*

## Цель задания

1. На практике разобрать работу с ссылочными типами через программный код.
2. Научиться правильно прописывать алгоритм обновления конфигурации.
3. Подготовить конфигурацию к последующей работе.

## Чеклист готовности к домашнему заданию

- [ ] Установить учебную платформу версии 8.3.22 или больше.
- [ ] Подготовить разработанную ранее конфигурацию "УправлениеИТФирмой"
- [ ] Просмотреть материал занятия «Табличные части».

## Инструкция к заданию

1. Решите описанные задачи в конфигураторе.
2. Протестируйте решение в пользовательском режиме, обязательно введите данные в базу, убедитесь, что все работает.
3. Отправьте на проверку в личном кабинете Нетологии один общий файл базы данных (.dt), содержащей решение всех задач.

## Задача 1. Версия конфигурации

### Описание задачи

Необходимо подготовить конфигурацию к возможным обновлениям написать "программную обвязку" для этого. То есть, реализовать алгоритмы, которые мы потом будем использовать при решении задач.

Добавить константу **ВерсияКонфигурации**, которая будет хранить версию конфигурации из свойств метаданных, с которой программа запускалась в последний раз. Хранение версии в данных позволит обнаружить запуск программы с изменённой версией и запустить код, заполняющий недостающие данные при обновлении версии.

### Процесс выполнения

1. Создайте константу **ВерсияКонфигурации** типа **Строка**, которая будет хранить текущую версию конфигурации. 
2. Добавьте константу в подсистему Справочники (или создайте для нее отдельную подсистему "Служебное", в этой подсистеме снимите флаг "Включать в командный интерфейс")
3. Скройте константу из командного интерфейса, сняв в свойствах флажок «Использовать стандартные команды».
4. Создайте общий модуль **ОбновлениеИнформационнойБазыСервер** с экспортной процедурой **ПриНачалеРаботыСистемы**, которая:
* проверит, совпадает ли версия конфигурации (_Метаданные.Версия_) со значением константы (_Константы.ВерсияКонфигурации.Получить()_);
* при совпадении ничего не сделает;
* при выявлении разницы вызовет ПриИзмененииВерсии(СтараяВерсия, НоваяВерсия);
* ПриИзмененииВерсии, в свою очередь, пока будет только устанавливать значение константы равным новой версии из метаданных
<details>
  <summary>Код</summary>
  
  ```bsl
	Процедура ПриНачалеРаботыСистемы() Экспорт

		НоваяВерсия = Метаданные.Версия;
		СтараяВерсия = Константы.ВерсияКонфигурации.Получить();
	
		Если НоваяВерсия = СтараяВерсия Тогда
			Возврат;
		КонецЕсли;
	
		ПриИзмененииВерсии(СтараяВерсия, НоваяВерсия);
	
	КонецПроцедуры

	Процедура ПриИзмененииВерсии(СтараяВерсия, НоваяВерсия)
	
		Константы.ВерсияКонфигурации.Установить(НоваяВерсия);
	
	КонецПроцедуры
  ```
  
</details>
5. Создайте общий модуль **ОбновлениеИнформационнойБазыВызовСервера** (не забудьте установить флаги, чтобы модуль был дступен с клиента) с экспортной процедурой **ПриНачалеРаботыСистемы**, которая вызовет одноименную процедуру в **ОбновлениеИнформационнойБазыСервер**
<details>
  <summary>Код</summary>
  
  ```bsl
	Процедура ПриНачалеРаботыСистемы() Экспорт
	
		ОбновлениеИнформационнойБазыСервер.ПриНачалеРаботыСистемы();
	
	КонецПроцедуры
  ```
6. В модуле приложения пропишите вызов процедуру из **ОбновлениеИнформационнойБазыВызовСервера**
<details>
  <summary>Код</summary>
  
  ```bsl
	Процедура ПриНачалеРаботыСистемы()
	
		ОбновлениеИнформационнойБазыВызовСервер.ПриНачалеРаботыСистемы();
	
	КонецПроцедуры
  ```
7. Таким образом, при обновлении информационной базы старой версии на конфигурацию новой версии будут выполнены обработчики обновления, необходимые новой версии. Сами обработчики обновления писать пока не нужно.
8. Проверьте, что при изменении версии в метаданных и запуске программы значение константы обновляется. Открыть константу можно через режим технического специалиста.

## Задача 2. Работа с табличной частью

### Описание задачи

Добавить в документы из задачи 1 сортировку строк по сумме, а также расчёт общего итога по колонке «Сумма».
Требуется реализовать отдельную команду, которая выполняла бы сортировку по сумме табличной части.

### Процесс выполнения

В форме обоих документов:
1. Добавить вывод подвала в табличной части
2. Для колонки Сумма заполнить свойство "Путь к данным подвала", можно так же, заполнить "Текст подвала"
<details>
  <summary>ПутьКДаннымПодвала</summary>
  Объект.Товары.ИтогСумма  
</details>
3. Добавьте команду "СортироватьПоСумме". Назначьте ей картинку.
4. Вынесите команду в командную панель табличной части. Настройте свойство кнопки Отображение тем способом, который покажется Вам наиболее корректным.
5. Пропишите программный код для сортировки таблицы

## Задача 3*. Сортировка в разных направлениях

_Это дополнительная задача, реализовывать ее не обязательно._
_Задача предназначена для тех студентов, которым первые 2 покажутся слишкм простыми._
_В процессе выполнения не будут даны примеры программного кода._

### Описание задачи

Реализуйте следующий сценарий поведения:

При первом нажатии на кнопку сортировки выполняется сортировка по возрастанию, при повторном нажатии - по убыванию. При каждом нажатии направление сортировки должно меняться.

### Процесс выполнения

1. Добавьте в форму реквизит СортироватьПоВозрастанию с типом Булево. Данный реквизит будет хранить текущее направление сортировки, на форму его выводить не нужно.
2. При каждом нажатии на кнопку, меняйте значение данного реквизита.
3. В зависимости от значения реквизита, сортируйте таблицу по возрастанию или убыванию.
4. Так же, можно менять заголовок и картинку на кнопке

## Задача 4*. Расчет количества по сумме

_Это дополнительная задача, реализовывать ее не обязательно._
_Задача предназначена для тех студентов, которым первые 2 покажутся слишкм простыми._
_В процессе выполнения не будут даны примеры программного кода._

### Описание задачи

Реализуйте более сложные расчеты в таблице для документа Реализация товаров и услуг. Например, к нам приходит покупатель и просит продать ему максимальное количество товара на определенную сумму. Необходимо рассчитать максимальное количество товара на указанную сумму.

### Процесс выполнения

1. Добавьте обработчик изменения суммы.
2. Если цена не установлена - никакие расчеты выполняться не должны.
3. Рассчитайте максимальное целое количество товара, которое можно продать по указанной цене.
4. Рассчитайте актуальную сумму.

## Пример
[Пример выполнения домашнего задания](examples/HW_4_2_example.md)

## Критерии оценки

Зачёт ставится, если:
1. Программа запускается, не возникает явных ошибок, исключений при выполнении программы (в том числе, если Вы начали делать дополнительную задачу, ее функционал не должен приводить к ошибкам и исключениям)
2. Созданы необходимые документы и журнал документов
3. Типы данных для реквизитов установлены корректно
4. Все объекты отображаются в интерфейсе
5. Введены тестовые данные
6. Корректно работает расчет в таблицах обоих документов, реализована сортировка, подсчет суммы по документу
7. В журнале документов выводятся необходимые графы

Задачи 1 и 2 обязательны к выполнению (кроме текста под спойлером "Дополнительно" - эти задачи делать не обязательно. Возможно, Вы вернетесь к ним позднее, после того, как изучите дополнительный материал). Задачи 3 и 4 - не обязательны. 

Пожалуйста, присылайте на проверку все задачи сразу, одним файлом выгрузки информационной базы (dt)

Любые вопросы по решению задач задавайте в чате учебной группы.

